---
title: "RF: Orig + Val"
author: "Valerie Odeh"
date: "10/6/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(randomForest)
library(caret)
library(pdp)
library(ggplot2)
library(rminer)
```
Analyses:
1) process parameters only
2) Day 4 NMR only
3) Day 6 NMR only
4) Day 6 Secretome only
5) Day 8 Secretome only
6) Day 6 NMR and Secretome 

Rows- Samples:
DOE 2 : row 1-18
Validation : row 19-38

Columns- Variables:
col 1-3 : just for identification
col 4-6 : PP
col 7-34 : endpoint responses
FOCUS
  Total Live Cells Responses
    viability: col 7
    total_live_cells: col 10
    Total.Live.cd4.Cells: col 24               
    Total.Live.cd8.Cells: col 25 
  Memory Responses
    col 26-32
    live_cd4_memory_frac:  col 26              
    Total.live.cd4.memory.cells: col 27         
    live_cd8_memory_frac col 28               
    Total.live.cd8.memory.cells: col 29
    live_memory_frac: col 30
    Total.Live.Memory.Cells: col 31 
    Ratio.of.CD4.to.CD8.Memory.Cells: col 32  
col 35-64: Secretomes Day 6
col 65-94: Secretomes Day 8
col 95-124: Secretomes Day 11
col 125-154: Secretomes Day 14
col 155-174: NMR Day 4
col 175-194: NMR Day 6
col 195-214: NMR Day 8
col 215-234: NMR Day 11
col 235-254: NMR Day 14


```{r}
xfile=setwd("/Users/valerieodeh/Documents/CMaT/ValidationDOE2/DataAnalyses")
getwd()
data=read.csv(file="AllData.csv",header=TRUE, sep=",") 

data[4:258] <- lapply(data[4:258], as.numeric)
```

```{r}
#y=value for the y to evaluate: number or name of column
#x=value for the predictors on the model
#mtry= c(1:number of predictors)
#ntree= c(200,300,400,500) values to evaluate ntree
#metric= metric to use to identify best tuning parameters. ex."Rsquared"
#for seed:
#size: run one time the number of the tune code and figure out the seed number size in the error message 

RFfunct <- function(y=1 , x=27:59, size=132, mtry=c(1:33), ntree=c(200,300,400,500), metric="Rsquared")
  {

Y <- data[,y]
X <- data[,x]
Data <- cbind(Y,X)

#Seed
seeds <- vector(mode = "list", length = nrow(X)+1)
for(i in 1:nrow(X)) seeds[[i]] <- sample(1000,size)
# For the final model
seeds[[nrow(X)+1]] <- 1

#Custom
customRF <- list(type = "Regression", library = "randomForest", loop = NULL)
customRF$parameters <- data.frame(parameter = c("mtry", "ntree"), class = rep("numeric", 2), label = c("mtry", "ntree"))
customRF$grid <- function(x, y, len = NULL, search = "grid") {}
customRF$fit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) {
  randomForest(x, y, mtry = param$mtry, ntree=param$ntree, ...)
}
customRF$predict <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  predict(modelFit, newdata)
customRF$prob <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  predict(modelFit, newdata, type = "prob")
customRF$sort <- function(x) x[order(x[,1]),]
customRF$levels <- function(x) x$classes

# train and tune model
control <- trainControl(method = "LOOCV", seed=seeds)
tunegrid <- expand.grid(.mtry=mtry, .ntree=ntree)

#Tuning
tune <- train(x=X,y=Y, method=customRF, metric=metric, tuneGrid=tunegrid, trControl=control,importance=TRUE)
final <- tune$finalModel

#RF
set.seed(seeds[[nrow(X)+1]])
rf <- randomForest(y=Y,x=X, mtry=tune$bestTune$mtry, ntree=tune$bestTune$ntree,importance=TRUE)
pred.rf <- predict(rf)
R2 <- mmetric(Y,pred.rf ,metric=c("R2"))
Imp <- as.data.frame(importance(rf,type=1))
impvar <- rownames(Imp)[which.max(Imp$`%IncMSE`)]

#PDP of most important var
PDP <- partial(rf,pred.var = c(paste(impvar)),plot = TRUE, plot.engine = "ggplot2",train = Data) + ggtitle("PDP") + theme(plot.title = element_text(hjust = 0.5))

#residual and prediction plots
plot1 <- qplot(x=pred.rf,y=Y) + ggtitle(paste(colnames(data)[y])) + theme(plot.title = element_text(hjust = 0.5)) + labs(x = "yhat", y="y")
                                                                              residual <- abs(Y-pred.rf)
sort(residual)
plot2 <- qplot(x=residual,y=Y) + ggtitle(paste(colnames(data)[y])) + theme(plot.title = element_text(hjust = 0.5)) + labs(x = "residual", y="y")
                                                                              #output
newList <- list("R2" = R2,"rf" = rf, varImpPlot(rf,type=1,n.var = 10), PDP, plot1, plot2 )
return(newList)
}

```


# NMR Day 4: Orig + Validation

##viability

```{r}
RFfunct(y=7, x=c(4:6,155:174), size=92, mtry=c(1:23))
```

##total_live_cells

```{r}
RFfunct(y=10, x=c(4:6,155:174), size=92, mtry=c(1:23))
```

##Total.Live.cd4.Cells

```{r}
RFfunct(y=24, x=c(4:6,155:174), size=92, mtry=c(1:23))
```

##Total.Live.cd8.Cells

```{r}
RFfunct(y=25, x=c(4:6,155:174), size=92, mtry=c(1:23))
```

##live_cd4_memory_frac

```{r}
RFfunct(y=26, x=c(4:6,155:174), size=92, mtry=c(1:23))
```

##live_cd8_memory_frac

```{r}
RFfunct(y=28, x=c(4:6,155:174), size=92, mtry=c(1:23))
```

##live_memory_frac

```{r}
RFfunct(y=30, x=c(4:6,155:174), size=92, mtry=c(1:23))
```



# NMR Day 6: Orig + Validation

##viability

```{r}
RFfunct(y=7, x=c(4:6,175:194), size=92, mtry=c(1:23))
```

##total_live_cells

```{r}
RFfunct(y=10,  x=c(4:6,175:194), size=92, mtry=c(1:23))
```

##Total.Live.cd4.Cells

```{r}
RFfunct(y=24,  x=c(4:6,175:194), size=92, mtry=c(1:23))
```

##Total.Live.cd8.Cells

```{r}
RFfunct(y=25,  x=c(4:6,175:194), size=92, mtry=c(1:23))
```

##live_cd4_memory_frac
```{r}
RFfunct(y=26, x=c(4:6,175:194), size=92, mtry=c(1:23))
```

##live_cd8_memory_frac

```{r}
RFfunct(y=28, x=c(4:6,175:194), size=92, mtry=c(1:23))
```

##live_memory_frac

```{r}
RFfunct(y=30,  x=c(4:6,175:194), size=92, mtry=c(1:23))
```


# Secretomes Day 6: Orig + Validation

##viability

```{r}
RFfunct(y=7, x=c(4:6,35:64), size=132, mtry=c(1:33))
```

##total_live_cells

```{r}
RFfunct(y=10, x=c(4:6,35:64), size=132, mtry=c(1:33))
```

##Total.Live.cd4.Cells

```{r}
RFfunct(y=24, x=c(4:6,35:64), size=132, mtry=c(1:33))
```

##Total.Live.cd8.Cells

```{r}
RFfunct(y=25, x=c(4:6,35:64), size=132, mtry=c(1:33))
```

##live_cd4_memory_frac
```{r}
RFfunct(y=26, x=c(4:6,35:64), size=132, mtry=c(1:33))
```

##live_cd8_memory_frac

```{r}
RFfunct(y=28, x=c(4:6,35:64), size=132, mtry=c(1:33))
```

##live_memory_frac

```{r}
RFfunct(y=30, x=c(4:6,35:64), size=132, mtry=c(1:33))
```

  Total Live Cells Responses
    viability: col 7
    total_live_cells: col 10
    Total.Live.cd4.Cells: col 24               
    Total.Live.cd8.Cells: col 25 

# Secretomes Day 8: Orig + Validation

##viability
```{r}
RFfunct(y=7, x=c(4:6,65:94), size=132, mtry=c(1:33))
```

##total_live_cells 

```{r}
RFfunct(y=10, x=c(4:6,65:94), size=132, mtry=c(1:33))
```

##Total.Live.cd4.Cells

```{r}
RFfunct(y=24, x=c(4:6,65:94), size=132, mtry=c(1:33))
```

##Total.Live.cd8.Cells

```{r}
RFfunct(y=25, x=c(4:6,65:94), size=132, mtry=c(1:33))
```

##live_cd4_memory_frac

```{r}
RFfunct(y=26, x=c(4:6,65:94), size=132, mtry=c(1:33))
```

##live_cd8_memory_frac

```{r}
RFfunct(y=28, x=c(4:6,65:94), size=132, mtry=c(1:33))
```

##live_memory_frac

```{r}
RFfunct(y=30, x=c(4:6,65:94), size=132, mtry=c(1:33))
```


# Secretomes + NMR Day 6: Orig + Validation

##viability 

```{r}
RFfunct(y=7, x=c(4:6,35:64,175:194), size=212, mtry=c(1:53))
```

##total_live_cells

```{r}
RFfunct(y=10, x=c(4:6,35:64,175:194), size=212, mtry=c(1:53))
```

##Total.Live.cd4.Cells 

```{r}
RFfunct(y=24, x=c(4:6,35:64,175:194), size=212, mtry=c(1:53))
```

##Total.Live.cd8.Cells

```{r}
RFfunct(y=25, x=c(4:6,35:64,175:194), size=212, mtry=c(1:53))
```

##live_cd4_memory_frac
```{r}
RFfunct(y=26, x=c(4:6,35:64,175:194), size=212, mtry=c(1:53))
```

##live_cd8_memory_frac

```{r}
RFfunct(y=28, x=c(4:6,35:64,175:194), size=212, mtry=c(1:53))
```

##live_memory_frac

```{r}
RFfunct(y=30, x=c(4:6,35:64,175:194), size=212, mtry=c(1:53))
```



```{r}
#y=value for the y to evaluate: number or name of column
#x=value for the predictors on the model
#mtry= c(1:number of predictors)
#ntree= c(200,300,400,500) values to evaluate ntree
#metric= metric to use to identify best tuning parameters. ex."Rsquared"
#for seed:
#size: run one time the number of the tune code and figure out the seed number size in the error message 

ppRFfunct <- function(y=1 , x=27:59, size=132, mtry=c(1:33), ntree=c(200,300,400,500), metric="Rsquared")
  {

Y <- data[,y]
X <- data[,x]
Data <- cbind(Y,X)

#Seed
seeds <- vector(mode = "list", length = nrow(X)+1)
for(i in 1:nrow(X)) seeds[[i]] <- sample(1000,size)
# For the final model
seeds[[nrow(X)+1]] <- 1

#Custom
customRF <- list(type = "Regression", library = "randomForest", loop = NULL)
customRF$parameters <- data.frame(parameter = c("mtry", "ntree"), class = rep("numeric", 2), label = c("mtry", "ntree"))
customRF$grid <- function(x, y, len = NULL, search = "grid") {}
customRF$fit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) {
  randomForest(x, y, mtry = param$mtry, ntree=param$ntree, ...)
}
customRF$predict <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  predict(modelFit, newdata)
customRF$prob <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
  predict(modelFit, newdata, type = "prob")
customRF$sort <- function(x) x[order(x[,1]),]
customRF$levels <- function(x) x$classes

# train and tune model
control <- trainControl(method = "LOOCV", seed=seeds)
tunegrid <- expand.grid(.mtry=mtry, .ntree=ntree)

#Tuning
tune <- train(x=X,y=Y, method=customRF, metric=metric, tuneGrid=tunegrid, trControl=control,importance=TRUE)
final <- tune$finalModel

#RF
set.seed(seeds[[nrow(X)+1]])
rf <- randomForest(y=Y,x=X, mtry=tune$bestTune$mtry, ntree=tune$bestTune$ntree,importance=TRUE)
pred.rf <- predict(rf)
R2 <- mmetric(Y,pred.rf ,metric=c("R2"))
Imp <- as.data.frame(importance(rf,type=1))
impvar <- rownames(Imp)[which.max(Imp$`%IncMSE`)]

#PDP of most important var
PDP <- partial(rf,pred.var = c(paste(impvar)),plot = TRUE, plot.engine = "ggplot2",train = Data) + ggtitle("PDP") + theme(plot.title = element_text(hjust = 0.5))

#residual and prediction plots
plot1 <- qplot(x=pred.rf,y=Y) + ggtitle(paste(colnames(data)[y])) + theme(plot.title = element_text(hjust = 0.5)) + labs(x = "yhat", y="y")
                                                                              residual <- abs(Y-pred.rf)
sort(residual)
plot2 <- qplot(x=residual,y=Y) + ggtitle(paste(colnames(data)[y])) + theme(plot.title = element_text(hjust = 0.5)) + labs(x = "residual", y="y")
                                                                              #output
newList <- list("R2" = R2,"rf" = rf, varImpPlot(rf,type=1,n.var = 3), PDP, plot1, plot2 )
return(newList)
}

```



# Only PP: Orig + Validation

##viability

```{r}
ppRFfunct(y=7, x=4:6, size=12, mtry=c(1:3))
```

##total_live_cells

```{r}
ppRFfunct(y=10, x=4:6, size=12, mtry=c(1:3))
```

##Total.Live.cd4.Cells 

```{r}
ppRFfunct(y=24, x=4:6, size=12, mtry=c(1:3))
```

##Total.Live.cd8.Cells

```{r}
ppRFfunct(y=25, x=4:6, size=12, mtry=c(1:3))
```

##live_cd4_memory_frac
```{r}
ppRFfunct(y=26, x=4:6, size=12, mtry=c(1:3))
```


##live_cd8_memory_frac

```{r}
ppRFfunct(y=28, x=4:6, size=12, mtry=c(1:3))
```


##live_memory_frac

```{r}
ppRFfunct(y=30, x=4:6, size=12, mtry=c(1:3))
```
