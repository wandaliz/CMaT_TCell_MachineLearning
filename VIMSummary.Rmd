---
title: 'Variable Importance Measures for RF, GBT, CIF.'
author: "Valerie Odeh"
date: "10/31/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(randomForest)
library(gbm)
library(party)
library(ggplot2)
library(rminer)
library(pdp)
```


```{r, echo=FALSE}
xfile=setwd("/Users/valerieodeh/Documents/CMaT/ValidationDOE2/DataAnalyses")
getwd()
data=read.csv(file="AllData.csv",header=TRUE, sep=",") 

data[4:258] <- lapply(data[4:258], as.numeric)
```
Analyses:
1) process parameters only
2) Day 4 NMR only
3) Day 6 NMR only
4) Day 6 Secretome only
5) Day 8 Secretome only
6) Day 6 NMR and Secretome 

Rows- Samples:
DOE 2 : row 1-18
Validation : row 19-38

Columns- Variables:
col 1-3 : just for identification
col 4-6 : PP
col 7-34 : endpoint responses
FOCUS
  Total Live Cells Responses
    viability: col 7
    total_live_cells: col 10
    Total.Live.cd4.Cells: col 24               
    Total.Live.cd8.Cells: col 25 
  Memory Responses
    col 26-32
    live_cd4_memory_frac:  col 26              
    Total.live.cd4.memory.cells: col 27         
    live_cd8_memory_frac col 28               
    Total.live.cd8.memory.cells: col 29
    live_memory_frac: col 30
    Total.Live.Memory.Cells: col 31 
    Ratio.of.CD4.to.CD8.Memory.Cells: col 32  
col 35-64: Secretomes Day 6
col 65-94: Secretomes Day 8
col 95-124: Secretomes Day 11
col 125-154: Secretomes Day 14
col 155-174: NMR Day 4
col 175-194: NMR Day 6
col 195-214: NMR Day 8
col 215-234: NMR Day 11
col 235-254: NMR Day 14



#Data:  PP + Secretome day 6 + NMR day6: Orig + Validation

##Permutation based Variable Importance Measure: 

We measure the importance of a feature by calculating the increase in the model’s prediction error (MSE) after permuting the feature. A feature is “important” if shuffling its values increases the model error, because in this case the model relied on the feature for the prediction. A feature is “unimportant” if shuffling its values leaves the model error unchanged, because in this case the model ignored the feature for the prediction. 

##Partial Dependece Plot:

Partial dependence plots give a graphical depiction of the marginal effect of a variable on the response. The prediction function is fixed at a few values of
the chosen features and averaged over the other features. These plots show how each variable or predictor affects the model's predictions.Partial Dependece Plot shown for the Top most important feature determined by the permutation based variable importance measure.


# Random Forest:  PP + Secretome day 6 + NMR day6
```{r, echo=FALSE}
#y=value for the y to evaluate: number or name of column
#x=value for the predictors on the model
#mtry= c(1:number of predictors)
#ntree= c(200,300,400,500) values to evaluate ntree

RFfunct <- function(y=26 , x=27:59, mtry=10, ntree=500)
  {

Y <- data[,y]
X <- data[,x]
Data <- cbind(Y,X)

set.seed(1)

#RF

rf <- randomForest(y=Y,x=X, mtry=mtry, ntree=ntree,importance=TRUE)
pred.rf <- predict(rf)
R2 <- mmetric(Y,pred.rf ,metric=c("R2"))
Imp <- as.data.frame(importance(rf,type=1))
impvar <- rownames(Imp)[which.max(Imp$`%IncMSE`)]
Imp <- cbind(variables = rownames(Imp), Imp)
colnames(Imp) <- c("variables", "importance")
Imp <- head(Imp[order(-Imp$importance),],20)
Imp <- transform(Imp, variables = reorder(variables, importance))
Imp$impscaled <-Imp$importance/max(Imp$importance)

IMP <- ggplot(data=Imp, aes(x=variables, y=impscaled)) +
  geom_point() + coord_flip() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))

PDP <- partial(rf,pred.var = c(paste(impvar)), plot = TRUE, plot.engine = "ggplot2",train = Data) + ggtitle("PDP") + theme(plot.title = element_text(hjust = 0.5))

plot1 <- qplot(x=pred.rf,y=Y) + ggtitle(paste(colnames(data)[y])) + theme(plot.title = element_text(hjust = 0.5)) + labs(x = "yhat", y="y")
                                                                              residual <- abs(Y-pred.rf)
sort(residual)
plot2 <- qplot(x=residual,y=Y) + ggtitle(paste(colnames(data)[y])) + theme(plot.title = element_text(hjust = 0.5)) + labs(x = "residual", y="y")

#output
newList <- list("R2" = R2,"rf" = rf, Imp, IMP, PDP, plot1, plot2, as.data.frame(pred.rf))
return(newList)
}

```


##live_cd4_memory_frac
```{r}
RFfunct(y=20, x=c(4:6,35:64,175:194), mtry=15, ntree = 500)
```

##Total.live.cd4.memory.cells

```{r}
RFfunct(y=27, x=c(4:6,35:64), mtry=18, ntree = 300)
```

##live_cd8_memory_frac

```{r}
RFfunct(y=28, x=c(4:6,35:64), mtry=11, ntree = 300)
```

##Total.live.cd8.memory.cells

```{r}
RFfunct(y=29, x=c(4:6,35:64), mtry=19, ntree = 300)
```

##live_memory_frac

```{r}
RFfunct(y=30, x=c(4:6,35:64), mtry=11, ntree = 200)
```

##Total.Live.Memory.Cells 

```{r}
RFfunct(y=31, x=c(4:6,35:64), mtry=11, ntree = 200)
```

##Ratio.of.CD4.to.CD8.Memory.Cells

```{r}
RFfunct(y=32, x=c(4:6,35:64), mtry=11, ntree = 200)
```

# Gradient Boosted Trees: PP + Secretome day 6 + NMR day6
```{r, echo=FALSE}
#y=value for the y to evaluate: number or name of column
#x=value for the predictors on the model  

GBMfunct <- function(y=1 , x=27:59){

Y <- data[,y]
X <- data[,x]
Data <- cbind(Y,X)

set.seed(1)
gbm.fit <- gbm(formula = Y ~ .,distribution = "gaussian", data = Data, bag.fraction=.7,n.minobsinnode=5, interaction.depth = 4, n.trees=10) 
p <- predict.gbm(gbm.fit,n.trees=10) 
R2 <- mmetric(Data$Y,p,metric=c("R2"))
gbtimp <- as.data.frame(summary(gbm.fit,method = permutation.test.gbm, plot=FALSE))
colnames(gbtimp) <- c("variables", "importance")
gbtimp <- head(gbtimp[order(-gbtimp$importance),],15)
gbtimp <- transform(gbtimp, variables = reorder(variables, importance))
gbtimp$impscaled <-gbtimp$importance/max(gbtimp$importance)
rownames(gbtimp) <- gbtimp[,1]
impvar <- rownames(gbtimp)[which.max(gbtimp$impscaled)]


IMP <- ggplot(data=gbtimp, aes(x=variables, y=impscaled)) +
  geom_point() + coord_flip() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))


#PDP of most important var
PDP <- partial(gbm.fit,pred.var = c(paste(impvar)), n.trees=10,plot = TRUE, plot.engine = "ggplot2",train = Data) + ggtitle("PDP") + theme(plot.title = element_text(hjust = 0.5))

#residual and prediction plots

plot1 <- qplot(x=p,y=Y) + ggtitle(paste(colnames(data)[y])) + theme(plot.title = element_text(hjust = 0.5)) + labs(x = "yhat", y="y")
residual <- abs(Y-p)

sort(residual)
plot2 <- qplot(x=residual,y=Y) + ggtitle(paste(colnames(data)[y])) + theme(plot.title = element_text(hjust = 0.5)) + labs(x = "Residuals", y="y")

#output
newList <- list("R2" = R2, IMP, gbtimp,PDP,plot1,plot2, as.data.frame(p))

return(newList)

}
```

##live_cd4_memory_frac
```{r}
GBMfunct(y=26, x=c(4:6,35:64))
```

##Total.live.cd4.memory.cells

```{r}
GBMfunct(y=27, x=c(4:6,35:64))
```

##live_cd8_memory_frac

```{r}
GBMfunct(y=28, x=c(4:6,35:64))
```

##Total.live.cd8.memory.cells

```{r}
GBMfunct(y=29, x=c(4:6,35:64))
```

##live_memory_frac

```{r}
GBMfunct(y=30, x=c(4:6,35:64))
```

##Total.Live.Memory.Cells 

```{r}
GBMfunct(y=31, x=c(4:6,35:64))
```

##Ratio.of.CD4.to.CD8.Memory.Cells

```{r}
GBMfunct(y=32, x=c(4:6,35:64))
```


# Conditional Inference Forest: PP + Secretome day 6 + NMR day6
```{r, echo=FALSE}
#y=value for the y to evaluate: number or name of column
#x=value for the predictors on the model  

#metric= metric to use to identify best tuning parameters. ex."Rsquared"


CIFfunct <- function(y=1 , x=27:58){

Y <- data[,y]
X <- data[,x]
Data <- cbind(Y,X)

set.seed(1)
cf <- cforest(Y~.,data=Data,  control = cforest_unbiased(ntree = 500))
vcf <- varimp(cf,conditional = TRUE)
p <- predict(cf) 
R2 <- mmetric(Data$Y,p,metric=c("R2"))


IMP <- as.data.frame(vcf)
IMP <- cbind(variables = rownames(IMP), IMP)
colnames(IMP) <- c("variables", "importance")
IMP <- head(IMP[order(-IMP$importance),],20)

IMP <- transform(IMP, variables = reorder(variables, importance))

IMP$impscaled <-IMP$importance/max(IMP$importance)

Imp <- ggplot(data=IMP, aes(x=variables, y=impscaled)) +
  geom_point() + coord_flip() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))

impvar <- rownames(IMP)[which.max(IMP$impscaled)]

#PDP of most important var
PDP <- partial(cf,pred.var = c(paste(impvar)),plot = TRUE, plot.engine = "ggplot2",train = Data) + ggtitle("PDP") + theme(plot.title = element_text(hjust = 0.5))

#residual and prediction plots
plot1 <- qplot(x=p,y=Y) + ggtitle(paste(colnames(data)[y])) + theme(plot.title = element_text(hjust = 0.5)) + labs(x = "yhat", y="y")
                                                                              residual <- abs(Y-p)
sort(residual)
plot2 <- qplot(x=residual,y=Y) + ggtitle(paste(colnames(data)[y])) + theme(plot.title = element_text(hjust = 0.5)) + labs(x = "residual", y="y")
                                                                              #output
newList <- list("R2" = R2, Imp, IMP, PDP, plot1, plot2, as.data.frame(p))
return(newList)

}
```


##live_cd4_memory_frac
```{r}
CIFfunct(y=26, x=c(4:6,35:64))
```

##Total.live.cd4.memory.cells

```{r}
CIFfunct(y=27, x=c(4:6,35:64))
```

##live_cd8_memory_frac

```{r}
CIFfunct(y=28, x=c(4:6,35:64))
```

##Total.live.cd8.memory.cells

```{r}
CIFfunct(y=29, x=c(4:6,35:64))
```

##live_memory_frac

```{r}
CIFfunct(y=30, x=c(4:6,35:64))
```

##Total.Live.Memory.Cells 

```{r}
CIFfunct(y=31, x=c(4:6,35:64))
```

##Ratio.of.CD4.to.CD8.Memory.Cells

```{r}
CIFfunct(y=32, x=c(4:6,35:64))
```

